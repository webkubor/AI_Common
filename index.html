<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Common Knowledge Base</title>
    <!-- GitHub Markdown Style -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <!-- Marked.js (Use specific version that supports UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #24292f;
            --sidebar-bg: #f6f8fa;
            --sidebar-border: #d0d7de;
            --header-height: 50px;
            --accent-color: #0969da;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* Header */
        header {
            height: var(--header-height);
            border-bottom: 1px solid var(--sidebar-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            background: #fff;
            flex-shrink: 0;
            z-index: 10;
        }
        .brand { font-weight: bold; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .tag { font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; font-weight: normal; }

        /* Layout */
        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #shortcuts {
            padding: 12px 0;
            border-bottom: 1px solid var(--sidebar-border);
        }

        #tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        /* Sidebar Items */
        .nav-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            transition: background 0.1s;
        }
        .nav-item:hover { background-color: #eaeef2; }
        .nav-item.active { background-color: #f1f8ff; color: var(--accent-color); border-right: 3px solid var(--accent-color); }
        .nav-item.header { font-size: 12px; color: #6e7781; font-weight: 600; padding: 16px 16px 8px; cursor: default; }
        .nav-item.header:hover { background: none; }

        /* Footer */
        #sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--sidebar-border);
            background: #fff;
            font-size: 12px;
        }
        #sidebar-footer code {
            display: block;
            background: #f6f8fa;
            padding: 8px;
            border-radius: 6px;
            margin-top: 6px;
            cursor: pointer;
            border: 1px solid #d0d7de;
            color: #d63384;
        }
        #sidebar-footer code:hover { border-color: #bbb; }

        /* Main Content */
        #main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .markdown-body {
            max-width: 850px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* Config Bar (Localhost only) */
        #config-bar { display: none; padding: 10px; border-bottom: 1px solid #ddd; }
        #config-bar input { width: 100%; padding: 4px; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        ğŸ“š AI Knowledge Base
        <span class="tag" id="repo-tag">Loading...</span>
    </div>
</header>

<div id="container">
    <div id="sidebar">
        <!-- Config for Localhost -->
        <div id="config-bar">
            <input type="text" id="repo-input" placeholder="user/repo (Enter to load)">
        </div>

        <div id="shortcuts">
            <div class="nav-item header">å¿«æ·è®¿é—®</div>
            <!-- Injected via JS -->
        </div>

        <div class="nav-item header">æ–‡ä»¶æµè§ˆ</div>
        <div id="tree-container">
            <!-- Injected via JS -->
        </div>

        <div id="sidebar-footer">
            <strong>ğŸš€ æ–°é¡¹ç›®åˆå§‹åŒ–</strong>
            <div style="margin-top:4px; opacity:0.8;">å¤åˆ¶å‘½ä»¤åˆ°ç»ˆç«¯:</div>
            <code onclick="navigator.clipboard.writeText(this.innerText); alert('å·²å¤åˆ¶!')">~/Documents/AI_Common/init_vibe.sh</code>
        </div>
    </div>

    <div id="main">
        <article id="content" class="markdown-body">
            <h3 style="text-align:center; color:#666; margin-top: 50px;">æ­£åœ¨è¿æ¥ GitHub API...</h3>
        </article>
    </div>
</div>

<script>
    // Configuration
    const STATE = {
        owner: 'webkubor',
        repo: 'AI_Common', 
        branch: 'main', 
        tree: []
    };

    const IGNORE_FILES = ['.DS_Store', '.gitignore', '.git', 'LICENSE', 'index.html', 'project_index.md'];
    
    const SHORTCUTS = [
        { name: 'ğŸ  è·¯ç”±æ€»è§ˆ', icon: 'ğŸ§­', path: 'index.md' },
        { name: 'ğŸ“ å¤ç›˜å·¥ä½œæµ', icon: 'ğŸ”¥', path: 'workflow_retro.md' },
        { name: 'ğŸ›  æŠ€æœ¯æ ˆåå¥½', icon: 'âš™ï¸', path: 'tech_stack.md' }
    ];

    // DOM Elements
    const els = {
        repoTag: document.getElementById('repo-tag'),
        tree: document.getElementById('tree-container'),
        shortcuts: document.getElementById('shortcuts'),
        content: document.getElementById('content'),
        configBar: document.getElementById('config-bar'),
        repoInput: document.getElementById('repo-input')
    };

    // --- Init ---
    async function init() {
        // Check Marked Library
        if (typeof marked === 'undefined') {
            els.content.innerHTML = `<div style="color:red; text-align:center;">
                âŒ Marked.js åº“åŠ è½½å¤±è´¥ã€‚<br>å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚
            </div>`;
            return;
        }

        const hostname = window.location.hostname;
        const pathParts = window.location.pathname.split('/').filter(p => p);

        // Scenario 1: GitHub Pages
        if (hostname.endsWith('github.io') && pathParts.length > 0) {
            STATE.owner = hostname.split('.')[0];
            STATE.repo = pathParts[0]; 
        } 
        // Scenario 2: Localhost
        else if (hostname === 'localhost' || hostname === '127.0.0.1') {
            els.configBar.style.display = 'block';
        }

        await loadRepo();
    }

    // --- Core Logic ---
    async function loadRepo() {
        els.repoTag.innerText = `${STATE.owner}/${STATE.repo}`;
        
        try {
            const apiUrl = `https://api.github.com/repos/${STATE.owner}/${STATE.repo}/git/trees/${STATE.branch}?recursive=1`;
            const res = await fetch(apiUrl);
            
            if (!res.ok) {
                if (res.status === 403) throw new Error("API è®¿é—®è¿‡å¿«ï¼Œè¯·ç¨åå†è¯• (Rate Limit)");
                if (res.status === 404) throw new Error("ä»“åº“ä¸å­˜åœ¨æˆ–ç§æœ‰");
                throw new Error(`API Error: ${res.status}`);
            }
            
            const data = await res.json();
            STATE.tree = data.tree.filter(item => {
                const name = item.path.split('/').pop();
                if (name.startsWith('.')) return false;
                if (IGNORE_FILES.includes(name)) return false;
                return true;
            });

            renderSidebar();
            
            // Auto load index.md
            const readme = STATE.tree.find(f => f.path.toLowerCase() === 'index.md');
            if (readme) loadFile(readme.path);

        } catch (err) {
            els.content.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <h2>âš ï¸ æ— æ³•åŠ è½½ä»“åº“</h2>
                    <p style="color:red;">${err.message}</p>
                    <p>å¦‚æœè¿™æ˜¯ç§æœ‰ä»“åº“ï¼Œæ­¤é¡µé¢æ— æ³•ç›´æ¥è®¿é—®ï¼ˆAPIéœ€è¦Tokenï¼‰ã€‚</p>
                    <p>è¯·ç¡®ä¿ä»“åº“æ˜¯ <strong>Public</strong> çš„ã€‚</p>
                </div>
            `;
        }
    }

    function renderSidebar() {
        // Shortcuts
        const shortcutContainer = document.createElement('div');
        SHORTCUTS.forEach(s => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.innerHTML = `<span>${s.icon}</span> ${s.name}`;
            div.onclick = () => {
                loadFile(s.path);
                setActive(div);
            };
            els.shortcuts.appendChild(div);
        });

        // Tree
        const ul = document.createElement('div');
        STATE.tree.sort((a, b) => {
            if (a.type === b.type) return a.path.localeCompare(b.path);
            return a.type === 'tree' ? -1 : 1;
        });
        
        STATE.tree.forEach(item => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            const depth = item.path.split('/').length - 1;
            div.style.paddingLeft = `${16 + depth * 12}px`;
            
            const icon = item.type === 'tree' ? 'ğŸ“' : 'ğŸ“„';
            div.innerHTML = `${icon} ${item.path.split('/').pop()}`;
            div.onclick = () => {
                if (item.type === 'blob') {
                    loadFile(item.path);
                    setActive(div);
                }
            };
            els.tree.appendChild(div);
        });
    }

    function setActive(el) {
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }

    async function loadFile(path) {
        els.content.innerHTML = '<p style="color:#888;">ğŸš€ æ­£åœ¨åŠ è½½æ–‡æ¡£...</p>';
        const rawUrl = `https://raw.githubusercontent.com/${STATE.owner}/${STATE.repo}/${STATE.branch}/${path}`;
        
        try {
            const res = await fetch(rawUrl);
            if (!res.ok) throw new Error('Fetch failed');
            const text = await res.text();
            
            if (path.endsWith('.md')) {
                // Marked.js parsing
                els.content.innerHTML = marked.parse(text);
            } else {
                els.content.innerHTML = `<pre><code>${text}</code></pre>`;
            }
        } catch (err) {
            els.content.innerHTML = `<p style="color:red;">æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹ (${err.message})</p>`;
        }
    }

    // Input handler
    els.repoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && els.repoInput.value.includes('/')) {
            [STATE.owner, STATE.repo] = els.repoInput.value.trim().split('/');
            loadRepo();
        }
    });

    init();
</script>
</body>
</html>