<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Common Knowledge Base</title>
    <!-- å¼•å…¥ GitHub Markdown æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <!-- å¼•å…¥ Marked è§£æå™¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #24292f;
            --sidebar-bg: #f6f8fa;
            --sidebar-border: #d0d7de;
            --hover-bg: #eaeef2;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0d1117;
                --text-color: #c9d1d9;
                --sidebar-bg: #010409;
                --sidebar-border: #30363d;
                --hover-bg: #161b22;
            }
        }

        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* Sidebar - File Tree */
        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .repo-header {
            padding: 16px;
            font-weight: bold;
            border-bottom: 1px solid var(--sidebar-border);
            font-size: 14px;
        }

        .file-tree {
            list-style: none;
            padding: 10px 0;
            margin: 0;
        }

        .file-item {
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-color);
            text-decoration: none;
        }

        .file-item:hover {
            background-color: var(--hover-bg);
        }

        .file-item.active {
            background-color: #388bfd26; /* Blue tint */
            color: #0969da;
            font-weight: 500;
        }
        
        .folder-item {
            font-weight: 600;
            padding-top: 10px;
            padding-bottom: 4px;
            color: #57606a;
        }

        /* Main Content - Markdown Viewer */
        #main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .markdown-body {
            max-width: 900px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* Loading / Error States */
        #status {
            padding: 20px;
            text-align: center;
            color: #57606a;
        }

        /* Input for manual repo entry (local dev) */
        #config-bar {
            padding: 10px;
            border-bottom: 1px solid var(--sidebar-border);
            display: none;
        }
        #config-bar input {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="config-bar">
        <input type="text" id="repo-input" placeholder="user/repo (Enter to load)">
    </div>
    <div class="repo-header" id="repo-name">Loading...</div>
    <div id="tree-container"></div>
</div>

<div id="main">
    <article id="content" class="markdown-body">
        <!-- Content will be rendered here -->
    </article>
</div>

<script>
    // Configuration
    const STATE = {
        owner: '',
        repo: '',
        branch: 'main', // default fallback
        tree: []
    };

    const IGNORE_FILES = ['.DS_Store', '.gitignore', '.git', 'LICENSE'];

    // DOM Elements
    const els = {
        repoName: document.getElementById('repo-name'),
        tree: document.getElementById('tree-container'),
        content: document.getElementById('content'),
        configBar: document.getElementById('config-bar'),
        repoInput: document.getElementById('repo-input')
    };

    /**
     * 1. Initialize: Try to detect GitHub Pages context or ask user
     */
    async function init() {
        const hostname = window.location.hostname;
        const pathParts = window.location.pathname.split('/').filter(p => p);

        // Heuristic: github.io deployment
        if (hostname.endsWith('github.io') && pathParts.length > 0) {
            STATE.owner = hostname.split('.')[0];
            STATE.repo = pathParts[0]; // First path segment is usually repo name
            await loadRepo();
        } else {
            // Localhost or custom domain -> Show Input
            els.configBar.style.display = 'block';
            els.repoName.innerText = 'è¯·é…ç½®ä»“åº“';
            els.content.innerHTML = `<div id="status">
                <h3>ğŸ› ï¸ æœ¬åœ°å¼€å‘æ¨¡å¼ / Custom Domain</h3>
                <p>æ— æ³•ä» URL è‡ªåŠ¨è¯†åˆ«ä»“åº“ã€‚</p>
                <p>è¯·åœ¨å·¦ä¸Šè§’è¾“å…¥ <code>username/repo</code> (ä¾‹å¦‚ <code>webkubor/AI_Common</code>) å¹¶å›è½¦ã€‚</p>
            </div>`;
        }
    }

    els.repoInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const val = els.repoInput.value.trim();
            if (val.includes('/')) {
                [STATE.owner, STATE.repo] = val.split('/');
                await loadRepo();
            }
        }
    });

    /**
     * 2. Load Repository Structure
     */
    async function loadRepo() {
        els.repoName.innerText = `${STATE.owner}/${STATE.repo}`;
        els.content.innerHTML = '<div id="status">æ­£åœ¨åŠ è½½ç›®å½•ç»“æ„...</div>';
        
        try {
            // Fetch default branch sha first to be safe, or just use recursive tree on main/master
            // Shortcut: Try 'main' first
            const apiUrl = `https://api.github.com/repos/${STATE.owner}/${STATE.repo}/git/trees/${STATE.branch}?recursive=1`;
            
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`GitHub API Error: ${res.status}`);
            
            const data = await res.json();
            STATE.tree = data.tree.filter(item => {
                // Filter out hidden files and folders
                const name = item.path.split('/').pop();
                if (name.startsWith('.')) return false;
                if (IGNORE_FILES.includes(name)) return false;
                // Only show markdown files or specific folders
                return true;
            });

            renderSidebar();
            
            // Auto load index.md or README.md
            const readme = STATE.tree.find(f => f.path.toLowerCase() === 'index.md' || f.path.toLowerCase() === 'readme.md');
            if (readme) loadFile(readme.path);

        } catch (err) {
            els.content.innerHTML = `<div id="status">âŒ åŠ è½½å¤±è´¥<br>${err.message}<br><br>å¯èƒ½åŸå› ï¼šAPI é€Ÿç‡é™åˆ¶æˆ–ä»“åº“ä¸å­˜åœ¨ã€‚</div>`;
        }
    }

    /**
     * 3. Render Sidebar
     */
    function renderSidebar() {
        const ul = document.createElement('ul');
        ul.className = 'file-tree';

        // Sort: Folders first, then files
        STATE.tree.sort((a, b) => {
            if (a.type === b.type) return a.path.localeCompare(b.path);
            return a.type === 'tree' ? -1 : 1;
        });

        // Simple grouping by top-level folder for cleaner view
        // For a deep tree, a recursive component is better, but here we just list paths indented
        
        STATE.tree.forEach(item => {
            const li = document.createElement('li');
            li.className = 'file-item';
            
            // Visual indentation based on slashes
            const depth = item.path.split('/').length - 1;
            li.style.paddingLeft = `${16 + depth * 12}px`;
            
            // Icon
            const icon = item.type === 'tree' ? 'ğŸ“' : 'ğŸ“„';
            li.innerText = `${icon} ${item.path.split('/').pop()}`;

            li.onclick = () => {
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                if (item.type === 'blob') {
                    loadFile(item.path);
                }
            };
            
            ul.appendChild(li);
        });

        els.tree.innerHTML = '';
        els.tree.appendChild(ul);
    }

    /**
     * 4. Fetch and Render File Content
     */
    async function loadFile(path) {
        els.content.innerHTML = '<div id="status">åŠ è½½ä¸­...</div>';
        
        // Use raw.githubusercontent.com for content
        const rawUrl = `https://raw.githubusercontent.com/${STATE.owner}/${STATE.repo}/${STATE.branch}/${path}`;
        
        try {
            const res = await fetch(rawUrl);
            if (!res.ok) throw new Error('Failed to fetch file');
            const text = await res.text();
            
            // Check extension
            if (path.endsWith('.md')) {
                els.content.innerHTML = marked.parse(text);
            } else {
                els.content.innerHTML = `<pre><code>${text}</code></pre>`;
            }
        } catch (err) {
            els.content.innerHTML = `<div id="status">æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹</div>`;
        }
    }

    // Start
    init();

</script>
</body>
</html>